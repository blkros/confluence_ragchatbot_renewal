services:
  rag-proxy:
    container_name: rag-proxy
    build:
      context: ./ai-stack
      dockerfile: Dockerfile
    env_file:
      - ./ai-stack/.env
    environment:
      MCP_URL: "http://mcp-confluence:9000/sse?version=${MCP_PROTOCOL_VERSION:-2025-06-18}"
      MCP_PROTOCOL_VERSION: "${MCP_PROTOCOL_VERSION:-2025-06-18}"
      DISABLE_INTERNAL_MCP: "${DISABLE_INTERNAL_MCP:-0}"
      INDEX_DIR: "/app/faiss_index"
      UPLOAD_DIR: "/app/uploads"
      SINGLE_SOURCE_COALESCE: "0"
      HF_HOME: /cache/hf
      TRANSFORMERS_CACHE: /cache/hf/transformers
      HF_HUB_ENABLE_HF_TRANSFER: "1"
    ports:
      - "8080:8080"
    networks:
      - app-net
    restart: unless-stopped
    volumes:
      - "${STORAGE_ROOT}/uploads:/app/uploads"
      - "${STORAGE_ROOT}/index:/app/faiss_index"
      - "${STORAGE_ROOT}/data:/app/data"
      - "${STORAGE_ROOT}/hf:/cache/hf"

  rag-router:
    container_name: rag-router
    build:
      context: ./ai-stack/rag-router
      dockerfile: Dockerfile
    environment:
      RAG_PROXY_URL: "http://rag-proxy:8080"
      OPENAI_URL: "${OPENAI_BASE_URL}"
      OPENAI_API_KEY: "${OPENAI_API_KEY}"
      OPENAI_MODEL: "${OPENAI_MODEL}"
      ROUTER_DEBUG: "1"
      ROUTER_MODEL_ID: "${ROUTER_MODEL_ID:-Qwen3-30B-A3B-FP8-router}"
      MAX_CTX_CHARS: "8000"
      RETRIEVE_K: "5"
      ROUTER_MIN_RAG_HITS: "0"
      ROUTER_TZ: "Asia/Seoul"
      ROUTER_MAX_TOKENS: "2048"
      ROUTER_MODEL_LIMIT_TOKENS: "16384"
      ROUTER_CTX_SAFETY_MARGIN: "512"
      ROUTER_KEEP_HISTORY: "0"
      ROUTER_USER_MAX_CHARS: "1200"
      ROUTER_ANSWER_MODE: "sections"
      ROUTER_BULLETS_MAX: "15"
      ROUTER_HEADING: ""
      ROUTER_SHOW_SOURCES: "1"
      ROUTER_SOURCES_MAX: "1"
      ROUTER_MIN_OVERLAP: "0.08"
      CONFLUENCE_SPACE: "${CONFLUENCE_SPACE:-}"
    depends_on:
      - rag-proxy
    networks:
      - app-net
    ports:
      - "8088:8000"
    restart: unless-stopped

  mcp-confluence:
    container_name: mcp-confluence
    build:
      context: ./mcp-confluence
      dockerfile: Dockerfile
    env_file:
      - ./mcp-confluence/.env
    environment:
      TRANSPORT: sse
      HOST: 0.0.0.0
      PORT: 9000
      CONFLUENCE_SPACE: "${CONFLUENCE_SPACE:-}"
      ENABLE_SITE_SEARCH: "${ENABLE_SITE_SEARCH:-true}"
      SITE_SEARCH_FALLBACK: "${SITE_SEARCH_FALLBACK:-0}"
      USE_HTML_SEARCH: "${USE_HTML_SEARCH:-0}"
    networks:
      - app-net
    restart: unless-stopped
    command: >
      sh -lc "uvicorn app.main:api --host 0.0.0.0 --port 9000"

  open-webui:
    container_name: open-webui
    build:
      context: ./open-webui
      dockerfile: Dockerfile
    environment:
      OPENAI_API_BASE_URL: "http://rag-router:8000/v1"
      OPENAI_API_KEY: "${OPENAI_API_KEY}"
      ENABLE_RAG_PROXY: "true"
      RAG_PROXY_URL: "http://rag-proxy:8080"
      BYPASS_EMBEDDING_AND_RETRIEVAL: "true"
      ENABLE_FORWARD_USER_INFO_HEADERS: "true"
      WEBUI_SECRET_KEY: "${WEBUI_SECRET_KEY}"
    depends_on:
      - rag-proxy
    ports:
      - "3000:8080"
    networks:
      - app-net
    restart: unless-stopped
    volumes:
      - "${STORAGE_ROOT}/open-webui-data:/app/backend/data"

  webui-to-rag-bridge:
    container_name: webui-to-rag-bridge
    image: python:3.11-slim
    depends_on:
      - rag-proxy
      - open-webui
    environment:
      RAG_PROXY: "http://rag-proxy:8080"
      WATCH_DIR: "/data/uploads"
      EXT_FILTER: "pdf,pptx,xlsx,txt,csv,md"
      POLL_SEC: "2"
      PYTHONUNBUFFERED: "1"
    networks:
      - app-net
    restart: unless-stopped
    volumes:
      - "${STORAGE_ROOT}/open-webui-data:/data:ro"
      - "./ai-stack/bridge/bridge.py:/bridge.py:ro"
    command: sh -lc "pip install --no-cache-dir requests && python /bridge.py"

networks:
  app-net:
    name: confluence-chatbot-net
